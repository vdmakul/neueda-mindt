<html>
<head>
    <title>Calculator Testing page</title>
    <script src="jquery-2.1.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">

        function test() {
            var formData = new FormData($('form')[0]);
            $.ajax({
                type: "POST",
                url: "/test",
                enctype: 'multipart/form-data',
                data: formData,
                //Options to tell jQuery not to process data or worry about content-type.
                cache: false,
                contentType: false,
                processData: false,

                beforeSend: function () {
                    hideError();
                    showProgress();
                },
                complete: function () {
                    hideProgress();
                },
                success: function (data) {
                    printResults(data);
                },
                error: function (xhr, status, error) {
                    hideProgress();
                    showError("Error: " + status + " " + error + "(" + xhr.responseXML + ")");
                }
            });
        }

        function printResults(results) {
            var $testResult = $("#testResult");
            var text = results.message;
            $testResult.text(results.message);
            $testResult.show();

            var ul = $("#failedList");
            if (results.allOk) {
                ul.hide();
            } else {
                ul.empty();
                results.failedTests.forEach(function (failedTest) {
                    var text = failedTest.testName +
                            ": expected <" + failedTest.expectedResult +
                            "> but was <" + failedTest.actualResult + ">";
                    ul.append("<li>" + text + "</li>");
                })
                ul.show();
            }

        }

        function showProgress() {
            $("#inProgress").show();
        }

        function hideProgress() {
            $("#inProgress").hide();
        }

        function validateFile(file) {
            $("#testResult").hide();
            $("#failedList").hide();

            name = file.name;
            size = file.size;
            type = file.type;

            var failWith = function (text) {
                $("#testButton").hide();
                var $errorMessage = $("#fileWarningMessage");
                $errorMessage.text(text);
                $errorMessage.show();
            }

            if (file.name.length < 1) {
                failWith(":(");
            } else if (file.size > 100000) {
                failWith("file is too big");
            }
            else if (file.type != "text/x-troff-mm") {
                if (file.type.length < 1) {
                    failWith("Unsupported file type");
                } else {
                    failWith("Unsupported file type: " + file.type);
                }
            } else {
                $("#fileWarningMessage").hide();
                $("#testButton").show();
            }
        }

        function showError(errorText) {
            var $errorMessage = $("#errorMessage");
            $errorMessage.text(errorText);
            $errorMessage.show();
        }

        function hideError() {
            $("#errorMessage").hide();
        }


    </script>
</head>

<body>

<form method="POST" enctype="multipart/form-data">
    Select MindMap to test<br/><input type="file" id="file" name="file"
                                      onchange="validateFile(document.getElementById('file').files[0])">
    <br/>

    <div id="fileWarningMessage" style="display: none;">
        <br>
    </div>
    <input id="testButton" type="button" value="Upload and test"
           style="display: none;" onclick="test()">
</form>

<div id="inProgress" style="display: none;">Processing...</div>
<div id="errorMessage" style="display: none;"></div>
<div id="testResult"></div>
<ul id="failedList" style="display: none;"></ul>

</body>
</html>
